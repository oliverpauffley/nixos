#+title: Emacs Literate Config
#+AUTHOR: Oliver Pauffley
#+OPTIONS: toc:1
#+PROPERTY: header-args :tangle config.el

* Config
 - TODO Dired controls for going up levels.
 - TODO Dired backspace removes symbols not characters.
 - TODO get new files to have some pregenerated content.
** Initial Setup
#+begin_src elisp
;; -*- lexical-binding: t -*-
;; disable unwanted UI elements
(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)

;; static cursor
(blink-cursor-mode -1)

;; turn off tabs
(setq-default indent-tabs-mode nil)
;; set indents to 4
(setq-default tab-width 4)
(setq-default require-final-newline "visit-save")

;; don't show the initial emacs screen
(setq inhibit-startup-screen t)
;; let me use y/n in prompts
(fset 'yes-or-no-p 'y-or-n-p)
;; no cowbell
(setq visible-bell nil)
(setq ring-bell-function #'ignore)
;; move backup files out of the way
(setq backup-directory-alist `(("." . "~/.saves")))
(setq create-lockfiles nil)
(setq backup-by-copying t)
(setq enable-recursive-minibuffers t)
(setq sentence-end-double-space nil)
(setq delete-old-versions t
  kept-new-versions 6
  kept-old-versions 2
  version-control t)
#+end_src
** Themes
I'm really liking the modus themes by Prot at the moment. Good using =f5= to rotate the theme is a nice way of spicing things up.

#+begin_src elisp
(use-package modus-themes
  :init
  (modus-themes-include-derivatives-mode 1)
  :bind
  (("<f5>" . modus-themes-rotate)
   ("C-<f5>" . modus-themes-select))
  :config
  ;; Your customizations here:
  (setq modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi-tinted)
        modus-themes-to-rotate modus-themes-items
        modus-themes-mixed-fonts t
        modus-themes-variable-pitch-ui t
        modus-themes-italic-constructs t
        modus-themes-bold-constructs t
        modus-themes-completions '((t . (bold)))
        modus-themes-prompts '(bold)
        modus-themes-headings
        '((agenda-structure . (variable-pitch light 2.2))
          (agenda-date . (variable-pitch regular 1.3))
          (t . (regular 1.15))))

  (modus-themes-load-theme 'modus-vivendi-tinted))
#+end_src
** Meow
Like vim but better!
#+begin_src elisp
(defun my-replace-or-yank ()
  "if a region is selected then replace else yank."
  (interactive)
  (if (use-region-p) (meow-replace) (meow-yank)))

  (defun meow-setup ()
    (setq meow-cheatsheet-layout meow-cheatsheet-layout-qwerty)
    ;; this stops the keypad from hijacking some commands
    (setq meow-keypad-meta-prefix nil
        meow-keypad-ctrl-meta-prefix nil
        meow-keypad-literal-prefix nil
        meow-use-cursor-position-hack t
        meow-use-dynamic-face-color nil
        )
    (with-eval-after-load 'org
    ;; for use with meow movement
    (modify-syntax-entry ?@ "_" org-mode-syntax-table))
    (defvar-keymap my-insert-map
      :doc "insert"
      )
    (define-key global-map (kbd "C-c i") my-insert-map)
    (meow-motion-define-key
     '("j" . meow-next)
     '("k" . meow-prev)
     '("<escape>" . ignore))
    (meow-leader-define-key
     ;; Use SPC (0-9) for digit arguments.
     '("1" . meow-digit-argument)
     '("2" . meow-digit-argument)
     '("3" . meow-digit-argument)
     '("4" . meow-digit-argument)
     '("5" . meow-digit-argument)
     '("6" . meow-digit-argument)
     '("7" . meow-digit-argument)
     '("8" . meow-digit-argument)
     '("9" . meow-digit-argument)
     '("0" . meow-digit-argument)
     '("/" . meow-keypad-describe-key)
     '("?" . meow-cheatsheet)
     '(";" . eval-expression)
     '(":" . execute-extended-command)
     '("=" . text-scale-increase)
     '("-" . text-scale-decrease)
     '("<SPC>" . consult-projectile-find-file)
     '("." . find-file)
     '("p" . 'projectile-command-map)
     '("i" . 'my-insert-map)
     )
    (meow-normal-define-key
     '("0" . meow-expand-0)
     '("9" . meow-expand-9)
     '("8" . meow-expand-8)
     '("7" . meow-expand-7)
     '("6" . meow-expand-6)
     '("5" . meow-expand-5)
     '("4" . meow-expand-4)
     '("3" . meow-expand-3)
     '("2" . meow-expand-2)
     '("1" . meow-expand-1)
     '("-" . negative-argument)
     '(";" . meow-reverse)
     '("," . meow-inner-of-thing)
     '("." . meow-bounds-of-thing)
     '("[" . meow-beginning-of-thing)
     '("]" . meow-end-of-thing)
     '("a" . meow-append)
     '("A" . meow-open-below)
     '("b" . meow-back-word)
     '("B" . meow-back-symbol)
     '("c" . meow-change)
     '("d" . meow-delete)
     '("D" . meow-backward-delete)
     '("e" . meow-next-word)
     '("E" . meow-next-symbol)
     '("f" . meow-find)
     '("F" . consult-outline-or-org-heading)
     '("g" . meow-cancel-selection)
     '("G" . meow-grab)
     '("h" . meow-left)
     '("H" . meow-left-expand)
     '("i" . meow-insert)
     '("I" . meow-open-above)
     '("j" . meow-next)
     '("J" . meow-next-expand)
     '("k" . meow-prev)
     '("K" . meow-prev-expand)
     '("M-k" . lsp-describe-thing-at-point)
     '("l" . meow-right)
     '("L" . meow-right-expand)
     '("m" . meow-join)
     '("n" . meow-search)
     '("o" . meow-tree-sitter-node)
     '("O" . meow-to-block)
     '("p" . my-replace-or-yank)
     '("P" . consult-yank-from-kill-ring)
     '("Q" . meow-goto-line)
     '("R" . meow-swap-grab)
     '("^" . consult-register-store)
     '("=" . consult-register)
     '("s" . meow-kill)
     '("t" . meow-till)
     '("u" . meow-undo)
     '("U" . meow-undo-in-selection)
     '("v" . meow-visit)
     '("/" . consult-line)
     '("?" . consult-ripgrep)
     '("w" . meow-mark-word)
     '("W" . meow-mark-symbol)
     '("x" . meow-line)
     '("X" . meow-goto-line)
     '("y" . meow-save)
     '("Y" . meow-sync-grab)
     '("z" . meow-pop-selection)
     '("'" . repeat)
     '("<escape>" . ignore)
     '("C-o" . xref-go-back)
     '("C-i" . xref-go-forward)
     '("C-d" . meow-page-down)
     '("C-u" . meow-page-up)
     )
    )

  (use-package meow
    :demand t
    :config
    (setq meow-char-thing-table
          '(
           (?\( . round)
           (?\) . round)
           (?\[ . square)
           (?\] . square)
           (?\{ . curly)
           (?\} . curly)
           (?g . string)
           (?e . symbol)
           (?w . window)
           (?b . buffer)
           (?p . paragraph)
           (?l . line)
           (?f . defun)
           (?. . sentence)))
    (setq meow-keypad-leader-dispatch "C-c"
  	      meow-use-clipboard t
        meow-goto-line-function 'consult-goto-line)
    (add-to-list 'meow-mode-state-list '(vterm-mode . insert))
    (add-to-list 'meow-mode-state-list '(eshell-mode . insert))
    (add-to-list 'meow-mode-state-list '(helpful-mode . insert))
    ;; keep the expand hints around a while longer
    (setq meow-expand-hint-remove-delay 3.0)
    ;; start git commits in insert mode
    (add-hook 'git-commit-mode-hook 'meow-insert-mode)
    (meow-global-mode 1)
          (meow-setup))
#+end_src
** Font
#+begin_src elisp
;; Main typeface
(set-face-attribute 'default nil :family "Mononoki Nerd Font Mono" :height 130)

;; Proportionately spaced typeface
(set-face-attribute 'variable-pitch nil :family "DepartureMono Nerd Font" :height 0.8)

;; Monospaced typeface
(set-face-attribute 'fixed-pitch nil :family "Mononoki Nerd Font Mono" :height 1.0)
#+end_src
** Org
#+begin_src elisp
  ;; (defvar-keymap my-org-menu
  ;;   :doc "org menu"
  ;;   "a" my-org-menu-attachments
  ;;   "b" my-org-menu-tables
  ;;   "d"  my-org-menu-delete
  ;;   "i" my-org-menu-insert
  ;;   )
    ;; (("C-c m" . (defvar-keymap org-menu))
    ;;  ("C-c m a" . (defvar-keymap org-menu-attachments))
    ;;  ("C-c m b" . (defvar-keymap org-menu-tables))
    ;;  ("C-c m d" . (defvar-keymap org-menu-delete))
    ;;  ("C-c m i" . (defvar-keymap org-menu-insert))
    ;;  ("C-c m c" . (defvar-keymap org-menu-clock))
    ;;  ("C-c m d" . (defvar-keymap org-menu-date))
    ;;  ("C-c m l" . (defvar-keymap org-menu-links))
    ;;  ("C-c m P" . (defvar-keymap org-menu-publish))
    ;;  ("C-c m r" . (defvar-keymap org-menu-refile))
    ;;  ("C-c m s" . (defvar-keymap org-menu-subtree))
    ;;  ("C-c m p" . (defvar-keymap org-menu-priority))
    ;;  )

  
  (use-package org
    :ensure t
    :init
    (load-file "~/.config/emacs/nix-vanilla/org/autoloads.el" )  
    (auto-fill-mode -1)
    ;; :bind-keymap
    ;; (("C-c m" . (defvar-keymap org-menu))
    ;;  ("C-c m a" . (defvar-keymap org-menu-attachments))
    ;;  ("C-c m b" . (defvar-keymap org-menu-tables))
    ;;  ("C-c m d" . (defvar-keymap org-menu-delete))
    ;;  ("C-c m i" . (defvar-keymap org-menu-insert))
    ;;  ("C-c m c" . (defvar-keymap org-menu-clock))
    ;;  ("C-c m d" . (defvar-keymap org-menu-date))
    ;;  ("C-c m l" . (defvar-keymap org-menu-links))
    ;;  ("C-c m P" . (defvar-keymap org-menu-publish))
    ;;  ("C-c m r" . (defvar-keymap org-menu-refile))
    ;;  ("C-c m s" . (defvar-keymap org-menu-subtree))
    ;;  ("C-c m p" . (defvar-keymap org-menu-priority))
    ;;  )
    ;; :bind (:map org-mode              
    ;;              ("S-RET"      . '+org/shift-return)
    ;;              ("C-RET"      . '+org/insert-item-below)
    ;;              ("C-S-RET"    . '+org/insert-item-above)
    ;;              ("C-M-RET"    . 'org-insert-subheading)
    ;;              ([C-return]   . '+org/insert-item-below)
    ;;              ([C-S-return] . '+org/insert-item-above)
    ;;              ([C-M-return] . 'org-insert-subheading)

                 ;; ("C-c m A" . 'org-archive-subtree-default)
                 ;; ("C-c m e" . 'org-export-dispatch)
    ;;              ("C-c m h" . 'org-toggle-heading)
    ;;              ("C-c m i" . 'org-toggle-item)
    ;;              ("C-c m I" . 'org-id-get-create)
    ;;              ("C-c m k" . 'org-babel-remove-result)
    ;;              ("C-c m K" . '+org/remove-result-blocks)
    ;;              ("C-c m n" . 'org-store-link)
    ;;              ("C-c m o" . 'org-set-property)
    ;;              ("C-c m q" . 'org-set-tags-command)
    ;;              ("C-c m t" . 'org-todo)
    ;;              ("C-c m T" . 'org-todo-list)
    ;;              ("C-c m x" . 'org-toggle-checkbox)
    ;;              ("C-c m a a" . 'org-attach)
    ;;              ("C-c m a d" . 'org-attach-delete-one)
    ;;              ("C-c m a D" . 'org-attach-delete-all)
    ;;              ("C-c m a n" . 'org-attach-new)
    ;;              ("C-c m a o" . 'org-attach-open)
    ;;              ("C-c m a O" . 'org-attach-open-in-emacs)
    ;;              ("C-c m a r" . 'org-attach-reveal)
    ;;              ("C-c m a R" . 'org-attach-reveal-in-emacs)
    ;;              ("C-c m a u" . 'org-attach-url)
    ;;              ("C-c m a s" . 'org-attach-set-directory)
    ;;              ("C-c m a S" . 'org-attach-sync)
    ;;              ("C-c m b -" . 'org-table-insert-hline)
    ;;              ("C-c m b a" . 'org-table-align)
    ;;              ("C-c m b b" . 'org-table-blank-field)
    ;;              ("C-c m b c" . 'org-table-create-or-convert-from-region)
    ;;              ("C-c m b e" . 'org-table-edit-field)
    ;;              ("C-c m b f" . 'org-table-edit-formulas)
    ;;              ("C-c m b h" . 'org-table-field-info)
    ;;              ("C-c m b s" . 'org-table-sort-lines)
    ;;              ("C-c m b r" . 'org-table-recalculate)
    ;;              ("C-c m b R" . 'org-table-recalculate-buffer-tables))
    ;;        (:prefix ("d" . "delete")
    ;;         "c" #'org-table-delete-column
    ;;         "r" #'org-table-kill-row)
    ;;        (:prefix ("i" . "insert")
    ;;         "c" #'org-table-insert-column
    ;;         "h" #'org-table-insert-hline
    ;;         "r" #'org-table-insert-row
    ;;         "H" #'org-table-hline-and-move)
    ;;       (:prefix ("c" . "clock")
    ;;        "c" #'org-clock-cancel
    ;;        "d" #'org-clock-mark-default-task
    ;;        "e" #'org-clock-modify-effort-estimate
    ;;        "E" #'org-set-effort
    ;;        "g" #'org-clock-goto
    ;;        "G" (cmd! (org-clock-goto 'select))
    ;;        "l" #'+org/toggle-last-clock
    ;;        "i" #'org-clock-in
    ;;        "I" #'org-clock-in-last
    ;;        "o" #'org-clock-out
    ;;        "r" #'org-resolve-clocks
    ;;        "R" #'org-clock-report
    ;;        "t" #'org-evaluate-time-range
    ;;        "=" #'org-clock-timestamps-up
    ;;        "-" #'org-clock-timestamps-down)
    ;;       (:prefix ("d" . "date/deadline")
    ;;        "d" #'org-deadline
    ;;        "s" #'org-schedule
    ;;        "t" #'org-time-stamp
    ;;        "T" #'org-time-stamp-inactive)
    ;;       (:prefix ("l" . "links")
    ;;        "c" #'org-cliplink
    ;;        "d" #'+org/remove-link
    ;;        "i" #'org-id-store-link
    ;;        "l" #'org-insert-link
    ;;        "L" #'org-insert-all-links
    ;;        "s" #'org-store-link
    ;;        "S" #'org-insert-last-stored-link
    ;;        "t" #'org-toggle-link-display
    ;;        "y" #'+org/yank-link)
    ;;       (:prefix ("P" . "publish")
    ;;        "a" #'org-publish-all
    ;;        "f" #'org-publish-current-file
    ;;        "p" #'org-publish
    ;;        "P" #'org-publish-current-project
    ;;        "s" #'org-publish-sitemap)
    ;;       (:prefix ("r" . "refile")
    ;;        "." #'+org/refile-to-current-file
    ;;        "c" #'+org/refile-to-running-clock
    ;;        "l" #'+org/refile-to-last-location
    ;;        "f" #'+org/refile-to-file
    ;;        "o" #'+org/refile-to-other-window
    ;;        "O" #'+org/refile-to-other-buffer
    ;;        "v" #'+org/refile-to-visible
    ;;        "r" #'org-refile
    ;;        "R" #'org-refile-reverse) ; to all `org-refile-targets'
    ;;       (:prefix ("s" . "tree/subtree")
    ;;        "a" #'org-toggle-archive-tag
    ;;        "b" #'org-tree-to-indirect-buffer
    ;;        "c" #'org-clone-subtree-with-time-shift
    ;;        "d" #'org-cut-subtree
    ;;        "h" #'org-promote-subtree
    ;;        "j" #'org-move-subtree-down
    ;;        "k" #'org-move-subtree-up
    ;;        "l" #'org-demote-subtree
    ;;        "n" #'org-narrow-to-subtree
    ;;        "r" #'org-refile
    ;;        "s" #'org-sparse-tree
    ;;        "A" #'org-archive-subtree-default
    ;;        "N" #'widen
    ;;        "S" #'org-sort)
    ;;       (:prefix ("p" . "priority")
    ;;        "d" #'org-priority-down
    ;;        "p" #'org-priority
    ;;        "u" #'org-priority-up))
    ;; (:map org-agenda
    ;;       (
    ;;       :m "C-SPC" #'org-agenda-show-and-scroll-up
    ;;       (:prefix ("d" . "date/deadline")
    ;;        "d" #'org-agenda-deadline
    ;;        "s" #'org-agenda-schedule)
    ;;       (:prefix ("c" . "clock")
    ;;        "c" #'org-agenda-clock-cancel
    ;;        "g" #'org-agenda-clock-goto
    ;;        "i" #'org-agenda-clock-in
    ;;        "o" #'org-agenda-clock-out
    ;;        "r" #'org-agenda-clockreport-mode
    ;;        "s" #'org-agenda-show-clocking-issues)
    ;;       (:prefix ("p" . "priority")
    ;;        "d" #'org-agenda-priority-down
    ;;        "p" #'org-agenda-priority
    ;;        "u" #'org-agenda-priority-up)
    ;;       "q" #'org-agenda-set-tags
    ;;       "r" #'org-agenda-refile
    ;;       "t" #'org-agenda-todo)))
    :config
    (setq org-hide-leading-stars             t
          org-hide-macro-markers             t
          org-ellipsis                       " â¤µ"
          org-image-actual-width             600
          org-redisplay-inline-images        t
          org-display-inline-images          t
          org-startup-with-inline-images     "inlineimages"
          org-pretty-entities                t
          org-fontify-whole-heading-line     t
          org-fontify-done-headline          t
          org-fontify-quote-and-verse-blocks t
          org-startup-indented               t
          org-startup-align-all-tables       t
          org-use-property-inheritance       t
          org-list-allow-alphabetical        t
          org-M-RET-may-split-line           nil
          org-src-window-setup               'split-window-below
          org-src-fontify-natively           t
          org-src-tab-acts-natively          t
          org-src-preserve-indentation       t
          org-log-done                       'time
  	    diary-file "~/org/diary"
  	    org-agenda-diary-file 'diary-file
  	    org-agenda-include-diary t
  	    diary-show-holidays-flag nil
  	    org-agenda-file-regexp "\\`[^.].*\\.org\\\(\\.gpg\\\)?\\'"
          org-directory "~/org"
          org-refile-targets '((nil :maxlevel . 3) (org-agenda-files :maxlevel . 10))
          org-agenda-files (list
                            "~/org/todo.org"
                            "~/org/work/todo.org"
                            "~/org/programming/todo.org"
                            "~/org/rpgs/todo.org"
                            "~/org/contacts.org.gpg")
          calendar-date-style 'european
          mark-diary-entries-in-calendar t
          org-confirm-babel-evaluate nil)
    :hook (org-mode . global-org-modern-mode)
    )
#+end_src
** Org latex
ox-latex is used to handle exporting latex from org files.
#+begin_src elisp 
  (use-package ox-latex
    :init
    :config
    (setq org-latex-with-hyperref nil) ;; stop org adding hypersetup{author..} to latex export

    ;; deleted unwanted file extensions after latexMK
    (setq org-latex-logfiles-extensions
          (quote ("lof" "lot" "tex~" "aux" "idx" "log" "out" "toc" "nav" "snm" "vrb" "dvi" "fdb_latexmk" "blg" "brf" "fls" "entoc" "ps" "spl" "bbl" "xmpi" "run.xml" "bcf" "acn" "acr" "alg" "glg" "gls" "ist")))

    (unless (boundp 'org-latex-classes)
      (setq org-latex-classes nil)))
#+end_src

#+begin_src elisp
(use-package ox-extra
  :config
    (ox-extras-activate '(latex-header-blocks ignore-headlines)))
#+end_src
** Org tempo
expand things like =<s= to src blocks
#+begin_src emacs-lisp 
(use-package org-tempo
  :ensure nil
  :after org)
#+end_src
** Org-contacts
#+begin_src emacs-lisp
(use-package org-contacts
  :after org
  :custom (org-contacts-files '("~/org/contacts.org.gpg")
  ))
#+end_src
** Ox Markdown
#+begin_src elisp
(use-package ox-gfm)
#+end_src
** Ox MD
#+begin_src elisp
(use-package ox-md)
#+end_src
** Ox Hugo
#+begin_src elisp
(use-package ox-hugo)
#+end_src
** Elfeed
#+begin_src elisp
(use-package elfeed
  :defer t
  :config (elfeed-set-max-connections 64))

(use-package elfeed-org
  :defer t
  :config
  (progn
    (elfeed-org)
    (setq rmh-elfeed-org-files (list "~/org/rss.org"))))

(use-package elfeed-goodies
  :defer t
  :config (elfeed-goodies/setup))
#+end_src
** Modeline
#+begin_src elisp
(use-package doom-modeline
  :config
  (setq doom-modeline-modal-icon t
        doom-modeline-hud t)
  :init (doom-modeline-mode 1))
#+end_src
*** Minions
Reduce the number of minor modes by putting them in a menu.
#+begin_src emacs-lisp
(use-package minions
  :config (minions-mode 1))
#+end_src
** Markdown-mode
#+begin_src elisp
(use-package markdown-mode
  :defer t
  :hook (markdown-mode . (lambda () (setq fill-column 72))))
#+end_src
** Direnv
#+begin_src elisp
;; direnv integration
(use-package envrc
  :if (executable-find "direnv")
  :init
  (setq envrc-debug t)
  (add-hook 'after-init-hook (lambda () (envrc-global-mode 1)))
  (advice-add 'cider-jack-in :around #'envrc-propagate-environment))
#+end_src
** Projectile
#+begin_src elisp
  (use-package projectile
    :custom
    (projectile-mode +1)
    (add-to-list 'projectile-globally-ignored-directories "/nix/store*")
    (setq
     projectile-project-search-path '(("~/code" . 5))
     projectile-enable-caching 'persistent
     projectile-auto-discover "true")
    :bind (("C-c \/" . project-find-regexp)
	   :map projectile-mode-map
         ("C-c p a" . projectile-add-known-project)
         ("C-c p p"  . projectile-switch-project)
         ("C-c p R" . projectile-run-shell-command-in-root)
         ("C-c p t" . projectile-run-eshell)
         ("C-c p T" . projectile-test-project))
         ("C-c p ." . find-file))
#+end_src
** Smart Parens
#+begin_src elisp
(use-package smartparens
  :ensure t
  :defer t
  :hook (prog-mode text-mode markdown-mode)
  :config
  ;; load default config
  (require 'smartparens-config))
#+end_src
** Vertico
#+begin_src elisp
;; Enable Vertico.
(use-package vertico
  ;;:custom
  ;; (vertico-scroll-margin 0) ;; Different scroll margin
  ;; (vertico-count 20) ;; Show more candidates
  ;; (vertico-resize t) ;; Grow and shrink the Vertico minibuffer
  ;; (vertico-cycle t) ;; Enable cycling for `vertico-next/previous'
  :init
  (vertico-mode))

;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :init
  (savehist-mode))

;; Emacs minibuffer configurations.
(use-package emacs
  :custom
  ;; Enable context menu. `vertico-multiform-mode' adds a menu in the minibuffer
  ;; to switch display modes.
  (context-menu-mode t)
  ;; Support opening new minibuffers from inside existing minibuffers.
  (enable-recursive-minibuffers t)
  ;; Hide commands in M-x which do not work in the current mode.  Vertico
  ;; commands are hidden in normal buffers. This setting is useful beyond
  ;; Vertico.
  (read-extended-command-predicate #'command-completion-default-include-p)
  ;; Do not allow the cursor in the minibuffer prompt
  (minibuffer-prompt-properties
   '(read-only t cursor-intangible t face minibuffer-prompt)))

;; Optionally use the `orderless' completion style.
(use-package orderless
  :custom
  ;; Configure a custom style dispatcher (see the Consult wiki)
  ;; (orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch))
  ;; (orderless-component-separator #'orderless-escapable-split-on-space)
  (completion-styles '(orderless basic))
  (completion-category-overrides '((file (styles partial-completion))))
  (completion-category-defaults nil) ;; Disable defaults, use our settings
  (completion-pcm-leading-wildcard t)) ;; Emacs 31: partial-completion behaves like substring
#+end_src
** Marginalia
#+begin_src elisp
;; Enable rich annotations using the Marginalia package
(use-package marginalia
  ;; Bind `marginalia-cycle' locally in the minibuffer.  To make the binding
  ;; available in the *Completions* buffer, add it to the
  ;; `completion-list-mode-map'.
  :bind (:map minibuffer-local-map
         ("M-A" . marginalia-cycle))

  ;; The :init section is always executed.
  :init

  ;; Marginalia must be activated in the :init section of use-package such that
  ;; the mode gets enabled right away. Note that this forces loading the
  ;; package.
  (marginalia-mode))
#+end_src
** Embark
#+begin_src elisp
(use-package embark-consult
  :demand t
  :config
  ;; always use completing-read for selecting actions, rather than keybinds
  (setq embark-prompter 'embark-completing-read-prompter)
  (setq wgrep-auto-save-buffer t)

  ;; setup initial action keybind
  (meow-normal-define-key
   '("C-." . embark-act))
  
  (defun ic-consult-bookmark ()
    "Call `consult-bookmark' without automatic buffer preview.
This is to prevent possible `tramp' calls."
    (interactive)
    (let ((consult-preview-key 'nil))
      (call-interactively #'consult-bookmark)))

  :bind (:map minibuffer-local-map
         ("C-." . embark-act)))
#+end_src
** Consult
#+begin_src elisp
;; Example configuration for Consult
(use-package consult

  ;; Enable automatic preview at point in the *Completions* buffer. This is
  ;; relevant when you use the default completion UI.
  :hook (completion-list-mode . consult-preview-at-point-mode)

  ;; The :init configuration is always executed (Not lazy)
  :init

  ;; Tweak the register preview for `consult-register-load',
  ;; `consult-register-store' and the built-in commands.  This improves the
  ;; register formatting, adds thin separator lines, register sorting and hides
  ;; the window mode line.
  (advice-add #'register-preview :override #'consult-register-window)
  (setq register-preview-delay 0.5)

  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  ;; Configure other variables and modes in the :config section,
  ;; after lazily loading the package.
  :config
  
  (defun consult-outline-or-org-heading (&optional match scope)
    "Call `consult-org-heading' when in an `org-mode' buffer, otherwise call
  `consult-outline'."
    (interactive)
    (if (eq major-mode 'org-mode)
        (consult-org-heading match scope)
      (consult-outline)))

  ;; Optionally configure preview. The default value
  ;; is 'any, such that any key triggers the preview.
  ;; (setq consult-preview-key 'any)
  ;; (setq consult-preview-key "M-.")
  ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
  ;; For some commands and buffer sources it is useful to configure the
  ;; :preview-key on a per-command basis using the `consult-customize' macro.
  (consult-customize
   consult-theme :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep consult-man
   consult-bookmark consult-recent-file consult-xref
   ;; consult-source-bookmark consult-source-file-register
   ;; consult-source-recent-file consult-source-project-recent-file
   ;; :preview-key "M-."
   :preview-key '(:debounce 0.4 any))

  ;; Optionally configure the narrowing key.
  ;; Both < and C-+ work reasonably well.
  (setq consult-narrow-key "<") ;; "C-+"

)
#+end_src
** Consult GH
#+begin_src elisp
(use-package consult-gh
  :after consult
  :custom
  (consult-gh-default-clone-directory "~/code")
  (consult-gh-show-preview t)
  (consult-gh-preview-key "C-o")
  (consult-gh-repo-action #'consult-gh--repo-browse-files-action)
  (consult-gh-large-file-warning-threshold 2500000)
  (consult-gh-confirm-name-before-fork nil)
  (consult-gh-notifications-show-unread-only nil)
  (consult-gh-default-interactive-command #'consult-gh-transient)
  (consult-gh-prioritize-local-folder nil)
  (consult-gh-group-dashboard-by :reason)
  ;;;; Optional
  (consult-gh-repo-preview-major-mode nil) ; show readmes in their original format
  (consult-gh-preview-major-mode 'org-mode) ; use 'org-mode for editing comments, commit messages, ...
  :config
  ;; Remember visited orgs and repos across sessions
  (add-to-list 'savehist-additional-variables 'consult-gh--known-orgs-list)
  (add-to-list 'savehist-additional-variables 'consult-gh--known-repos-list)
  ;; Enable default keybindings (e.g. for commenting on issues, prs, ...)
  (consult-gh-enable-default-keybindings))


;; Install `consult-gh-embark' for embark actions
(use-package consult-gh-embark
  :config
  (consult-gh-embark-mode +1))


;; Install `consult-gh-forge' for forge actions
(use-package consult-gh-forge
 :config
 (consult-gh-forge-mode +1)
 (setq consult-gh-forge-timeout-seconds 20))
#+end_src
** Consult-LSP
#+begin_src elisp
(use-package consult-lsp
  :defer t
  :bind (:map lsp-mode-map
         ([remap consult-imenu-multi] . #'consult-lsp-symbols)
         :map lsp-command-map
         ("C-c c a" . #'consult-lsp-diagnostics)
         ("C-c f f" . #'consult-lsp-symbols)
         ))
#+end_src
** Consult-Projectile
#+begin_src elisp
(use-package consult-projectile
  :ensure t
  :config
  (bind-keys :prefix-map switch
             :prefix "C-c p"
             :prefix-docstring "switch things"
             )
  :bind (:map switch
              ("b" . #'consult-projectile-switch-to-buffer)
              ("p" . #'consult-projectile-switch-project)
              ))
#+end_src
** Corfu
#+begin_src elisp
(use-package corfu
  ;; Optional customizations
  ;; :custom
  ;; (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
  ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
  ;; (corfu-preview-current nil)    ;; Disable current candidate preview
  ;; (corfu-preselect 'prompt)      ;; Preselect the prompt
  ;; (corfu-on-exact-match 'insert) ;; Configure handling of exact matches
  :config
  ;; Enable auto completion, configure delay, trigger and quitting
(setq corfu-auto t
      corfu-auto-delay 0.25
      corfu-quit-no-match 'separator) ;; or t
  :init

  ;; Recommended: Enable Corfu globally.  Recommended since many modes provide
  ;; Capfs and Dabbrev can be used globally (M-/).  See also the customization
  ;; variable `global-corfu-modes' to exclude certain modes.
  (global-corfu-mode)

  ;; Enable optional extension modes:
  (corfu-history-mode)
  (corfu-popupinfo-mode)
  )

;; A few more useful configurations...
(use-package emacs
  :custom
  ;; TAB cycle if there are only few candidates
  ;; (completion-cycle-threshold 3)

  ;; Enable indentation+completion using the TAB key.
  ;; `completion-at-point' is often bound to M-TAB.
  (tab-always-indent 'complete)

  ;; Emacs 30 and newer: Disable Ispell completion function.
  ;; Try `cape-dict' as an alternative.
  (text-mode-ispell-word-completion nil)

  ;; Hide commands in M-x which do not apply to the current mode.  Corfu
  ;; commands are hidden, since they are not used via M-x. This setting is
  ;; useful beyond Corfu.
  (read-extended-command-predicate #'command-completion-default-include-p))

(use-package cape
  :init
  ;; Add to the global default value of `completion-at-point-functions' which is
  ;; used by `completion-at-point'.  The order of the functions matters, the
  ;; first function returning a result wins.  Note that the list of buffer-local
  ;; completion functions takes precedence over the global list.
  (add-hook 'completion-at-point-functions #'cape-dabbrev)
  (add-hook 'completion-at-point-functions #'cape-file)
  (add-hook 'completion-at-point-functions #'cape-elisp-block)
  (add-hook 'completion-at-point-functions #'cape-history))
#+end_src
*** Kind-Icon
#+begin_src elisp
(use-package kind-icon
  :ensure t
  :after corfu
  :custom
  (kind-icon-blend-background t)
  (kind-icon-default-face 'corfu-default) ; only needed with blend-background
  :config
  (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))
#+end_src
** Dashboard
#+begin_src elisp
(use-package dashboard
  :ensure t
  :config
  (setq dashboard-items '((bookmarks . 5)
                        (projects  . 5)
                        (agenda    . 5)
                        ))
  (setq dashboard-icon-type 'all-the-icons)
  (dashboard-setup-startup-hook))
#+end_src
** Windows
*** Keybinds
#+begin_src elisp
(defun my-split-and-follow-below ()
  "Split the selected window in two with the new window is bellow.
This uses `split-window-below' but follows with the cursor."
  (interactive)
  (split-window-below)
  (other-window 1))

(defun my-split-and-follow-right ()
  "Split the selected window in two with the new window is to the right.
This uses `split-window-right' but follows with the cursor."
  (interactive)
  (split-window-right)
  (other-window 1))

(defvar-keymap my-window-keymap
  :doc "window controls"
  "v" #'split-window-right
  "V" #'my-split-and-follow-right
  "s" #'split-window-below
  "S" #'my-split-and-follow-below
  "l" #'windmove-right
  "h" #'windmove-left
  "j" #'windmove-down
  "k" #'windmove-up
  "d" #'delete-window
  "o" #'window-other
  "=" #'balance-windows
  )

(define-key global-map (kbd "C-c w") my-window-keymap)
#+end_src
** Git
*** Keybinds
Copying some bits from DOOM. Bind "C-m" for git actions and "C-m c" for git create actions.
#+begin_src elisp
(defvar-keymap my-git-create-keymap
  :doc "git create commands"
  "p" #'forge-create-pullreq
  "b" #'magit-branch-and-checkout
  "c" #'magit-commit-create)
(define-key global-map (kbd "C-c g c") my-git-create-keymap)
(define-key global-map (kbd "C-c g g") #'magit-status)
(define-key global-map (kbd "C-c g T") #'git-timemachine-toggle)
#+end_src
*** Magit
#+begin_src elisp
(use-package magit
  :init
  :defer t
  :config
  (setq magit-repository-directories `(("~/code". 5)))
  (setq straight-vc-git-default-protocol "ssh")
  :bind (:map magit-mode-map (("x" . magit-discard)))
)
#+end_src
*** Forge
#+begin_src elisp
(use-package forge
  :after magit
  :defer t
  :config
  (setq forge-owned-accounts '(("oliverpauffley" nil)))
  )
#+end_src
** Which key
#+begin_src elisp
(use-package which-key
    :defer t
    :config
    (which-key-mode 1))
#+end_src
** Icons!
#+begin_src elisp
(use-package all-the-icons)
#+end_src
** LSP
#+begin_src elisp
(use-package lsp-mode
  :demand t
  :defer t
  :commands lsp

  :init
  ;; keep session file tidy
  ;;(setq lsp-session-file (concat user-cache-directory "lsp-session-v1"))
  ;; don't show the top breadcrumbs by default
  (setq lsp-headerline-breadcrumb-enable nil)
  ;; keep more log data
  (setq lsp-log-max 10000)
  (setq lsp-completion-provider :none) ;; we use Corfu!
  :init
  (defun my/orderless-dispatch-flex-first (_pattern index _total)
    (and (eq index 0) 'orderless-flex))

  (defun my/lsp-mode-setup-completion ()
    (setf (alist-get 'styles (alist-get 'lsp-capf completion-category-defaults))
          '(orderless))
    ;; Optionally configure the first word as flex filtered.
    (setq-local orderless-style-dispatchers (list #'my/orderless-dispatch-flex-first))
    ;; Optionally configure the cape-capf-buster.
    (setq-local completion-at-point-functions (list (cape-capf-buster #'lsp-completion-at-point))))

  :bind (:map global-map
              ("C-c g d" . #'xref-find-definitions)
              ("C-c c a" . #'lsp-execute-code-action)
              ("C-c c i" . #'lsp-find-implementation)
              ("C-c c r" . #'lsp-rename)
              )
  :hook
  ((lsp-mode . lsp-enable-which-key-integration)
   (csharp-mode . lsp)
   (haskell-ts-mode . lsp)
   (haskell-literate-mode . lsp)
   (lsp-completion-mode . my/lsp-mode-setup-completion)
   (go-ts-mode . lsp)))
#+end_src

#+RESULTS:
: lsp-rename

** Snippets
#+begin_src elisp
(use-package yasnippet
  :ensure t
  :defer t
  :bind (:prefix-map my-insert :prefix "C-c i" ("s" . yas-insert-snippet))
  :config
  (setq
   yas-verbosity 1
   yas-wrap-around-region t)

  (with-eval-after-load 'yasnippet
    (setq yas-snippet-dirs '(yasnippet-snippets-dir)))

  (yas-reload-all)
  (yas-global-mode))

(use-package yasnippet-snippets         ; Collection of snippets
  :ensure t)
#+end_src
** Yatemplate
Like yasnippet but for new files
#+begin_src elisp
(use-package autoinsert
  :hook (my/startup . (lambda () (auto-insert-mode 1)))
  :config
  (use-package yatemplate)
  (yatemplate-fill-alist)
  :custom
  (yatemplate-dir (expand-file-name "templates" user-emacs-directory))
  ;; (setq auto-insert t)
  )
#+end_src
** Programming Languages
*** Formatting
Most formatting tasks should be handled with apheleia .
#+begin_src elisp
(use-package apheleia
  :config
  (apheleia-global-mode t))
#+end_src
*** Haskell
#+begin_src elisp
(use-package haskell-ts-mode
  :custom
  (haskell-ts-font-lock-level 4)
  (haskell-ts-use-indent t)
  (haskell-ts-ghci "ghci")
  (haskell-ts-use-indent t)
)

(use-package haskell-mode)

(use-package consult-hoogle)

(use-package lsp-haskell
  :custom
 (lsp-haskell-server-path "haskell-language-server-wrapper")
  :after (lsp-mode))

(use-package cabal-mode
  :mode (("\\.cabal$" . cabal-mode))
  :defer)


(org-babel-do-load-languages
 'org-babel-load-languages
 '((haskell . t)))

#+end_src
*** Go
#+begin_src elisp
(defun my-go-mode-setup ()
  "Setup Go mode to my liking."
  (add-hook 'before-save-hook #'lsp-format-buffer t t)
  (add-hook 'before-save-hook #'lsp-organize-imports t t)
  (setq gofmt-command "goimports")
  (add-hook 'before-save-hook 'gofmt nil t)
  )

(use-package go-mode
  :ensure t
  :mode (("\\.go$" . go-ts-mode))
  :hook ((go-mode go-ts-mode) . my-go-mode-setup)
  :custom (gofmt-command "goimports"))
#+end_src
*** Lisp
#+begin_src elisp
(use-package lisp
  :hook
  (after-save . check-parens))

(use-package elisp-mode
  :bind
  (:map emacs-lisp-mode-map
        ("C-c C-d C-d" . describe-function)
        ("C-c C-d d" . describe-function)
        ("C-c C-b" . eval-buffer)))

(use-package highlight-quoted
  :config
  (add-hook 'emacs-lisp-mode-hook 'highlight-quoted-mode)
  (add-hook 'emacs-lisp-mode-hook 'highlight-defined-mode)
  )
#+end_src
** Helpful
#+begin_src elisp
(use-package helpful
  :demand t
  :bind (:map global-map
         ([remap describe-function] . #'helpful-callable)
         ([remap describe-variable] . #'helpful-variable)
         ([remap describe-key] . #'helpful-key)
         ("C-h f" . #'helpful-function)))
#+end_src
** Auth
#+begin_src elisp
(setq auth-sources '("~/.authinfo.gpg")
      auth-source-do-cache nil)
#+end_src
** Yaml
#+begin_src elisp
(use-package yaml-mode
  :demand t
  :config
  (add-to-list 'auto-mode-alist '("\\.ya?ml\\.j2\\'" . yaml-mode))
  )
#+end_src
** Dired
#+begin_src elisp
(use-package dired
  :bind (:map dired-mode-map
              ("_" . dired-up-directory))
  :config
  (setq dired-movement-style 'bounded
        dired-dwim-target t
        ;; Always copy/delete recursively
        dired-recursive-copies 'always
        dired-recursive-deletes 'top
        dired-kill-when-opening-new-dired-buffer t
        dired-auto-revert-buffer #'dired-buffer-stale-p
        dired-isearch-filenames t
        ;; Ask whether destination dirs should get created when copying/removing files.
        dired-create-destination-dirs 'ask
        )
)
#+end_src
** Perspective
#+begin_src emacs-lisp 
(use-package perspective
  :bind
  ("C-x C-b" . persp-list-buffers)
  ("C-c g t" . persp-next)
  :custom
  (persp-mode-prefix-key (kbd "C-c M-p")) 
  (consult-customize consult--source-buffer :hidden t :default nil)
  (add-to-list 'consult-buffer-sources persp-consult-source)
  :init
  (persp-mode))
#+end_src
We also use persp-projectile to link projectile and perspective together
#+begin_src emacs-lisp
(use-package persp-projectile
  :bind
  (:map projectile-mode-map ("s-s"  . projectile-persp-switch-project)
  ))
#+end_src
** Text
#+begin_src elisp
(add-hook 'text-mode-hook 'flyspell-mode)
#+end_src
** Line numbers
#+begin_src elisp
(add-hook 'prog-mode-hook 'display-line-numbers-mode)
(add-hook 'text-mode-hook 'display-line-numbers-mode)

;; use lines displayed on screen rather than new line characters; so folds work
(setq-default display-line-numbers-type 'visual)
;; show the current line as absolute
(setq-default display-line-numbers-current-absolute t)
;; ignore folding when determining relative lines
(setq-default display-line-numbers-widen t)
;; start with a width of 3 ...
(setq-default display-line-numbers-width 3)
;; ... and allow it to shrink :(
(setq-default display-line-numbers-grow-only nil)
#+end_src
** Tree-Sitter
#+begin_src elisp
(use-package treesit
  :custom
  (treesit-font-lock-level 4))

(use-package tree-sitter-langs 
  :after tree-sitter
  :custom (global-tree-sitter-mode t))

(with-eval-after-load 'meow
  (use-package meow-tree-sitter
    :demand
    :config
    (meow-tree-sitter-register-defaults)))
#+end_src
** Elisp
#+begin_src elisp
(add-hook 'emacs-lisp-mode-hook 'turn-on-eldoc-mode)
(add-hook 'lisp-interaction-mode-hook 'turn-on-eldoc-mode)
#+end_src
** Protobuf-ts-mode
#+begin_src emacs-lisp
(use-package protobuf-ts-mode
  :mode (("\\.proto" . protobuf-ts-mode)))
#+end_src
** COMMENT Eshell
#+begin_src elisp
(defun eshell-here ()
  "Opens up a new shell in the directory associated with the
current buffer's file. The eshell is renamed to match that
directory to make multiple eshell windows easier."
  (interactive)
  (let* ((parent (if (buffer-file-name)
                     (file-name-directory (buffer-file-name))
                   default-directory))
         (height (/ (window-total-height) 3))
         (name   (car (last (split-string parent "/" t)))))
    (split-window-vertically (- height))
    (other-window 1)
    (eshell "new")
    (rename-buffer (concat "*eshell: " name "*"))

    (insert (concat "ls"))
    (eshell-send-input)))


(defun eshell/x ()
  (interactive)
  (insert "exit")
  (eshell-send-input)
  (delete-window))

(use-package eshell-z)

(use-package eshell
  :bind (("C-c o t" . eshell-here)
         ("C-c e t" . eshell/x))
  :config
  (setq mode-line-format nil)
  :hook
  ((eshell-mode . (lambda ()
                    (setq-local corfu-auto nil)
                    (corfu-mode)))
   (eshell-mode . (lambda ()
                    (setenv "TERM" "xterm-256color")))
   (eshell-mode .
          (lambda ()
            (require 'eshell-z)))))
#+end_src
** Ws-Butler
#+begin_src elisp
(use-package ws-butler :ensure t :hook (prog-mode . ws-butler-mode))
#+end_src
** Editorconfig
#+begin_src elisp
(use-package editorconfig
  :ensure t
  :config
  (editorconfig-mode 1))
#+end_src
** Flycheck
#+begin_src elisp
(use-package flycheck
  :ensure t
  :init (global-flycheck-mode))
#+end_src
** Exercism
#+begin_src emacs-lisp
(use-package exercism)
#+end_src
** Vaarn.el
#+begin_src emacs-lisp 
(use-package vaarn)
#+end_src
** Hyperbole 
#+begin_src emacs-lisp 
(use-package hyperbole
  :init
  (hyperbole-mode))
#+end_src
** PDF-Tools
#+begin_src emacs-lisp 
(use-package pdf-tools
  :defer t
  :mode "\\.pdf\\'"
  :bind (:map pdf-view-mode-map
              ("c" . (lambda ()
                       (interactive)
                       (if header-line-format
                           (setq header-line-format nil)
                         (nano-modeline-pdf-mode))))
              ("j" . pdf-view-next-line-or-next-page)
              ("k" . pdf-view-previous-line-or-previous-page))
  :init (pdf-loader-install)
  :config (add-to-list 'revert-without-query ".pdf"))

#+end_src
** Scheme
#+begin_src elisp
(use-package geiser-chez)

(org-babel-do-load-languages
 'org-babel-load-languages
 '((scheme . t)))
#+end_src
** Terraform
#+begin_src elisp
(use-package terraform-mode
  :custom (terraform-indent-level 4)
  :config
  (defun my-terraform-mode-init ()
    ;; if you want to use outline-minor-mode
    ;; (outline-minor-mode 1)
    )

  (add-hook 'terraform-mode-hook 'my-terraform-mode-init))
#+end_src
